---
phase: 02-interaction-polish
plan: 06
type: execute
wave: 3
depends_on: [02-03, 02-04]
files_modified:
  - src/inspect/InspectPanel.tsx
  - src/toolbar/Toolbar.tsx
  - src/store/viewer-store.ts
  - src/App.tsx
autonomous: true
requirements: [CTRL-01, CTRL-02, CTRL-03, CTRL-04]

must_haves:
  truths:
    - "Magnifying glass icon in toolbar toggles a right-side inspect panel open/closed"
    - "Inspect panel shows a collapsible, interactive tree breakdown of the authorization model"
    - "At full graph level, all types are root-level collapsible nodes in the tree"
    - "In subgraph view, tree re-roots to show current subgraph's root as tree root"
    - "Each tree node shows name + expression (e.g., 'document#can_view: admin | editor | member')"
    - "Tree nodes are dimension-colored (matching edge colors from the graph)"
    - "Clicking a tree node navigates into that node's subgraph"
    - "Hovering a tree node highlights the corresponding card/row on the canvas"
    - "Filter input at top of panel for quick text search within the tree"
    - "Panel overlays on top of the canvas (no canvas resize)"
  artifacts:
    - path: "src/inspect/InspectPanel.tsx"
      provides: "Inspect panel with interactive authorization model tree"
      contains: "InspectPanel"
    - path: "src/toolbar/Toolbar.tsx"
      provides: "Inspect panel toggle button"
      contains: "inspect"
  key_links:
    - from: "src/inspect/InspectPanel.tsx"
      to: "src/store/viewer-store.ts"
      via: "nodes, dimensions, navigationStack, navigateToSubgraph subscriptions"
      pattern: "navigateToSubgraph|navigationStack"
    - from: "src/inspect/InspectPanel.tsx"
      to: "src/store/hover-store.ts"
      via: "setHoveredRow/setHoveredCard for tree node hover"
      pattern: "setHoveredRow|setHoveredCard"
    - from: "src/toolbar/Toolbar.tsx"
      to: "src/store/viewer-store.ts"
      via: "inspectOpen toggle"
      pattern: "inspectOpen"
---

<objective>
Build the inspect panel -- a right-side overlay with an interactive tree view of the authorization model that replaces the deleted legend panel. The tree re-roots on subgraph navigation, supports click-to-navigate, hover-to-highlight, and text filtering.

Purpose: The inspect panel provides a structured alternative to graph exploration. Users can see the full authorization model hierarchy, search within it, and navigate by clicking tree nodes. It replaces CTRL-01 (dimension toggles), CTRL-02 (solo mode), CTRL-03 (type filtering), CTRL-04 (permissions-only toggle), and CTRL-06 (legend) per user decisions.

Output: InspectPanel component with tree view, toolbar integration.
</objective>

<execution_context>
@/Users/thedoc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thedoc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interaction-polish/02-CONTEXT.md
@.planning/phases/02-interaction-polish/02-RESEARCH.md
@.planning/phases/02-interaction-polish/02-03-SUMMARY.md

@src/store/viewer-store.ts
@src/store/hover-store.ts
@src/toolbar/Toolbar.tsx
@src/types.ts
@src/theme/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inspectOpen state to viewer-store and toolbar toggle button</name>
  <files>
    src/store/viewer-store.ts
    src/toolbar/Toolbar.tsx
  </files>
  <action>
    **Store (src/store/viewer-store.ts):**
    - Add `inspectOpen: boolean` to ViewerStore interface.
    - Add `toggleInspect: () => void` action.
    - Initial value: `inspectOpen: false`.
    - Implementation: `toggleInspect: () => set((s) => ({ inspectOpen: !s.inspectOpen }))`.

    **Toolbar (src/toolbar/Toolbar.tsx):**
    - Subscribe to `inspectOpen` and `toggleInspect` from viewer-store.
    - Add a new ToolbarButton with a magnifying glass icon (distinct from search icon -- use a magnifying glass with a tree/hierarchical indicator, or simply use a panel/sidebar icon).
    - Suggested icon: a tree/hierarchical icon (three horizontal lines with indentation) or a book/index icon. Per CONTEXT.md, the icon is a magnifying glass. Reuse the search SVG but differentiate -- OR use a list/tree icon. Since the CONTEXT.md specifically says "magnifying glass icon", use a magnifying glass SVG similar to the search one but slightly different (e.g., with a small eye/inspect indicator). Simplest: use the same magnifying glass SVG but with a tooltip "Inspect model" to differentiate from search.
    - Actually, to avoid confusion with the search button, use a different icon: a sidebar/panel icon (vertical rectangle with horizontal lines). The tooltip says "Inspect (magnifying glass per spec)".
    - Position: after the search button group, before the permissions toggle.
    - Active state: highlight in mustard when `inspectOpen === true`.

    **Note:** The inspect panel component itself will be added to App.tsx in Task 2.
  </action>
  <verify>
    Run `npm run build` -- must compile without errors.
    Run `npm run lint` -- must pass.
  </verify>
  <done>
    inspectOpen state and toggleInspect action added to viewer-store. Toolbar has inspect toggle button with appropriate icon. Build and lint pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: InspectPanel component with interactive tree view</name>
  <files>
    src/inspect/InspectPanel.tsx
    src/App.tsx
  </files>
  <action>
    **Create directory and component: `src/inspect/InspectPanel.tsx`**

    **Component structure:**
    - Default export: `InspectPanel` component.
    - Subscribe to relevant store state:
      - `inspectOpen` from viewer-store (controls visibility).
      - `nodes` from viewer-store (AuthorizationNode[] for tree building).
      - `edges` from viewer-store (for expression building).
      - `dimensions` from viewer-store (for tree node coloring).
      - `navigationStack` from viewer-store (for re-rooting).
      - `navigateToSubgraph` from viewer-store (for click-to-navigate).
      - `setHoveredRow`, `setHoveredCard`, `clearHover` from hover-store (for tree node hover).
      - `fullEdges`, `fullNodes` from viewer-store (for hover BFS).

    **Tree data model (local, not in Zustand):**
    ```typescript
    interface TreeNode {
      id: string;              // AuthorizationNode ID
      label: string;           // Display name (relation or type name)
      expression?: string;     // Transformed expression
      color?: string;          // Dimension color (for bindings)
      section: 'type' | 'binding' | 'relation' | 'permission';
      children: TreeNode[];
    }
    ```

    **Tree building (useMemo):**
    - **At full graph (navigationStack empty):** Each type is a root node. Its children are its relations/permissions grouped by section (bindings, then relations, then permissions). This mirrors the card structure.
    - **In subgraph:** Re-root the tree to show the current subgraph's entry node as the root, with its upstream/downstream dependencies as children. Use the current frame's `visibleTypeIds` and `relevantRowIds` to determine which nodes appear.
      - For upstream subgraphs: the entry node (a permission/relation) is root. Its dependencies (upstream sources) are children.
      - For downstream subgraphs: the entry node (a type) is root. Its consumers (downstream targets) are children.
    - Use `useMemo` keyed on `[nodes, edges, dimensions, navigationStack.length]`.

    **Tree rendering (recursive component):**
    - Render a `TreeItem` component recursively.
    - Each TreeItem:
      - Expand/collapse toggle (chevron icon, rotates 90deg when expanded).
      - Color dot: dimension color for bindings, `getTypeColor(typeName)` for types, neutral for relations/permissions.
      - Label: `name` text.
      - Expression: if present, show after label in muted text separated by `:`.
      - Full format: `document#can_view: admin | editor | member`
    - Default expanded: types are expanded at overview, subgraph root is expanded.
    - **Expand/collapse is local state** (not in Zustand). Use a `Set<string>` of expanded node IDs in component state.

    **Tree node interaction:**
    - **Click:** Determine direction based on node type:
      - Type nodes: `navigateToSubgraph(node.id, 'downstream')`.
      - Permission/relation nodes: `navigateToSubgraph(node.id, 'upstream')`.
      - Close palette does NOT happen -- panel stays open and re-roots.
    - **Hover:** On mouse enter:
      - For type nodes: `setHoveredCard(node.id, fullNodes, fullEdges)`.
      - For relation/permission nodes: `setHoveredRow(node.id, fullEdges)`.
    - **Mouse leave:** `clearHover()`.

    **Filter input:**
    - Text input at the top of the panel.
    - Filters tree nodes by matching label or expression text (case-insensitive).
    - When filter is active, auto-expand all matching branches (parents of matching nodes are also shown).
    - When filter is cleared, revert to default expand state.
    - Simple `String.includes()` matching is sufficient here (fuse.js is for the command palette; the tree filter is simpler).

    **Panel styling:**
    - Position: `fixed right-0 top-0 bottom-0 z-40`.
    - Width: 320px (Claude's discretion per CONTEXT.md).
    - Background: solid dark `rgba(15, 23, 41, 0.95)` (no glass transparency per CONTEXT.md).
    - Border: left border `1px solid #2a3a5c`.
    - Shadow: subtle left shadow for depth.
    - Slide-in/out animation: `transform: translateX(100%)` when closed, `translateX(0)` when open. CSS transition 250ms.
    - Header: "Inspect" title + close button (X icon).
    - Filter input: full-width text input with search icon, below header.
    - Tree area: scrollable `overflow-y-auto flex-1`.
    - No canvas resize -- panel overlays.

    **Wire into App.tsx:**
    - Import `InspectPanel` from `./inspect/InspectPanel`.
    - Render as a sibling to Canvas and Toolbar in the overlay stack.
    - The panel handles its own visibility via `inspectOpen` subscription.

    **Important constraints:**
    - NO tree view library (rc-tree, react-arborist). Build a simple recursive component (~100 lines). The authorization model tree is shallow (max 3 levels: type > section > relations/permissions).
    - Use `import type` for type-only imports.
    - Tree nodes use CSS-only hover states (no complex interaction hooks).
    - Dimension colors from `dimensions` Map: look up by the binding's relation name (same as dimension name).
  </action>
  <verify>
    Run `npm run build` -- must compile without errors.
    Run `npm run lint` -- must pass.
    Test: click inspect toggle in toolbar -> panel slides in from right -> tree shows all types -> click a type -> navigates into downstream subgraph, panel re-roots -> hover a tree node -> corresponding card highlights on canvas.
  </verify>
  <done>
    InspectPanel renders a collapsible interactive tree of the authorization model. Re-roots on subgraph navigation. Tree nodes are dimension-colored, clickable (navigate), and hoverable (highlight canvas). Filter input filters tree by text. Panel overlays canvas from the right. Build and lint pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with zero errors
- `npm run lint` passes clean
- Inspect toggle button visible in toolbar
- Clicking toggle opens right-side panel with tree view
- Tree shows all types as root nodes at overview level
- In subgraph, tree re-roots to current entry node
- Tree nodes show name + expression + dimension color
- Clicking tree node navigates into subgraph (panel stays open, re-roots)
- Hovering tree node highlights corresponding card/row on canvas
- Filter input filters tree nodes by text
- Panel overlays canvas without resizing it
</verification>

<success_criteria>
1. Inspect panel opens/closes via toolbar toggle
2. Tree view shows full authorization model hierarchy at overview
3. Tree re-roots when in subgraph view
4. Tree node click navigates into subgraph
5. Tree node hover highlights corresponding canvas element
6. Filter input works for text search within tree
7. Panel overlays canvas (no resize)
8. Build and lint pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-interaction-polish/02-06-SUMMARY.md`
</output>
