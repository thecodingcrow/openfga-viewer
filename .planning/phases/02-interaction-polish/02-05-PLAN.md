---
phase: 02-interaction-polish
plan: 05
type: execute
wave: 3
depends_on: [02-03, 02-04]
files_modified:
  - src/toolbar/CommandPalette.tsx
  - package.json
autonomous: true
requirements: [CTRL-05]

must_haves:
  truths:
    - "Cmd+K opens a center-screen command palette with backdrop dim"
    - "Fuzzy search matches abbreviated input across full names (e.g., 'dv' matches 'document#can_view')"
    - "Results are grouped by type card (type name as group header)"
    - "Each result shows row type icon (circle=relation, diamond=permission) and dimension color dot"
    - "Selecting a result enters the subgraph for that node"
    - "Empty input shows last 5 recently visited nodes"
    - "Full keyboard navigation: arrow keys, Enter confirms, Esc closes"
  artifacts:
    - path: "src/toolbar/CommandPalette.tsx"
      provides: "Upgraded command palette with fuzzy search, grouped results, subgraph navigation"
      contains: "Fuse"
    - path: "package.json"
      provides: "fuse.js dependency"
      contains: "fuse.js"
  key_links:
    - from: "src/toolbar/CommandPalette.tsx"
      to: "src/store/viewer-store.ts"
      via: "navigateToSubgraph on result selection, recentlyVisited for empty input"
      pattern: "navigateToSubgraph|recentlyVisited"
    - from: "src/toolbar/CommandPalette.tsx"
      to: "fuse.js"
      via: "fuzzy search import"
      pattern: "import Fuse"
---

<objective>
Upgrade the command palette to use fuse.js for fuzzy matching, group results by type card, show row type icons and dimension colors, navigate into subgraphs on selection, and display recently visited nodes on empty input.

Purpose: The command palette is the primary keyboard-driven search interface. Fuzzy matching enables quick navigation (e.g., typing "dv" to find "document#can_view"). Selecting a result enters the subgraph for exploration.

Output: Fully featured command palette with fuzzy search, grouped results, visual indicators, and subgraph navigation.
</objective>

<execution_context>
@/Users/thedoc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thedoc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interaction-polish/02-CONTEXT.md
@.planning/phases/02-interaction-polish/02-RESEARCH.md
@.planning/phases/02-interaction-polish/02-03-SUMMARY.md

@src/toolbar/CommandPalette.tsx
@src/store/viewer-store.ts
@src/types.ts
@src/theme/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install fuse.js</name>
  <files>
    package.json
  </files>
  <action>
    Run: `npm install fuse.js`

    This adds `fuse.js` v7 (ESM, tree-shakeable, works with Vite without config).
    Expected size: ~6KB gzipped.
  </action>
  <verify>
    `npm ls fuse.js` shows the installed version.
    `npm run build` still compiles.
  </verify>
  <done>
    fuse.js is installed as a production dependency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite CommandPalette with fuzzy search, grouped results, and subgraph navigation</name>
  <files>
    src/toolbar/CommandPalette.tsx
  </files>
  <action>
    **Rewrite `CommandPaletteInner` component:**

    **Data source:**
    - Subscribe to `nodes` from viewer-store (AuthorizationNode[]).
    - Subscribe to `dimensions` from viewer-store (Map<string, Dimension>).
    - Subscribe to `recentlyVisited` from viewer-store (string[]).
    - Subscribe to `navigateToSubgraph` from viewer-store.
    - Subscribe to `setSearchOpen` from viewer-store (for closing palette).

    **Build Fuse instance (memoized):**
    ```typescript
    import Fuse from 'fuse.js';

    // Filter to non-type nodes (relations and permissions only) for search
    // Also include type nodes for card-level search
    const searchItems = useMemo(() =>
      nodes.map((n) => ({
        id: n.id,
        type: n.type,
        relation: n.relation ?? '',
        fullId: n.id,
        kind: n.kind,
        isPermission: n.isPermission,
        definition: n.definition ?? '',
      })),
      [nodes]
    );

    const fuse = useMemo(() => new Fuse(searchItems, {
      keys: [
        { name: 'fullId', weight: 2 },       // "document#can_view" â€” primary
        { name: 'type', weight: 1.5 },        // "document"
        { name: 'relation', weight: 1.5 },    // "can_view"
        { name: 'definition', weight: 0.5 },
      ],
      threshold: 0.4,
      includeScore: true,
      includeMatches: true,
      minMatchCharLength: 1,
    }), [searchItems]);
    ```

    **Search logic:**
    ```typescript
    const results = useMemo(() => {
      if (!query.trim()) {
        // Show recently visited when empty
        return recentlyVisited
          .map((id) => nodes.find((n) => n.id === id))
          .filter(Boolean);
      }
      return fuse.search(query).map((r) => r.item);
    }, [query, fuse, recentlyVisited, nodes]);
    ```

    **Group results by type card:**
    ```typescript
    const grouped = useMemo(() => {
      const groups = new Map<string, typeof results>();
      for (const item of results) {
        const type = item.type;
        const group = groups.get(type);
        if (group) group.push(item);
        else groups.set(type, [item]);
      }
      return groups;
    }, [results]);
    ```

    **Render grouped results:**
    - For each group: render a sticky group header with the type name in `getTypeColor(typeName)`.
    - Under each header: render result items.
    - Each result item shows:
      - **Row type icon:** circle (8px, filled) for relations, diamond (8px, rotated square) for permissions. Use inline SVG for the diamond shape.
      - **Dimension color dot:** if the node is a binding and has a dimension color, show a small colored dot. Look up dimension color from `dimensions.get(node.relation)?.color`.
      - **Name:** `relation` name (or `type` if it's a type-kind node).
      - **Expression:** if present, show in muted text, truncated.

    **Selection behavior:**
    - On result click or Enter key: determine navigation direction.
      - If the selected node is a permission: `navigateToSubgraph(node.id, 'upstream')`.
      - If the selected node is a type (kind === 'type'): `navigateToSubgraph(node.type, 'downstream')`.
      - If the selected node is a relation: `navigateToSubgraph(node.id, 'upstream')`.
    - Close the palette after navigation: `onClose()`.

    **Keyboard navigation:**
    - Maintain `highlightIndex` state across the flattened result list.
    - Arrow Up/Down moves selection.
    - Enter confirms selection.
    - Esc closes palette.
    - Scroll highlighted item into view.

    **Visual styling:**
    - Keep existing HUD panel styling (`.hud-panel` class).
    - Backdrop: semi-transparent dark overlay (`fixed inset-0 z-60`).
    - Panel: `fixed top-[20vh] left-1/2 -translate-x-1/2 w-[480px] max-h-[420px] z-60`.
    - Search input with magnifying glass icon (reuse existing SVG).
    - Group headers: slightly indented, muted text, type color accent dot.
    - Highlighted result: subtle mustard background (`${blueprint.accent}12`).

    **Recently visited section:**
    - When `query` is empty and `recentlyVisited.length > 0`, show a "Recent" label above the results.
    - Max 5 items.

    **Important constraints:**
    - Keep the remount pattern (wrapper renders null when closed, mounts inner on open).
    - Use `import type` for type-only imports.
    - Do NOT hand-roll fuzzy matching -- use Fuse.js for all search logic.
    - The `nodes` array from the store includes ALL AuthorizationNodes (type nodes + relation nodes). Search across all of them.
  </action>
  <verify>
    Run `npm run build` -- must compile without errors.
    Run `npm run lint` -- must pass.
    Test: open Cmd+K, type abbreviated input (e.g., "dv"), confirm "document#can_view" appears. Select a result, verify it navigates into subgraph.
  </verify>
  <done>
    Command palette uses fuse.js for fuzzy search. Results grouped by type with row type icons and dimension color dots. Selecting a result navigates into subgraph. Empty input shows recently visited. Full keyboard navigation works. Build and lint pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with zero errors
- `npm run lint` passes clean
- fuse.js is in package.json dependencies
- Cmd+K opens command palette with backdrop
- Typing abbreviated input matches across full names
- Results are grouped by type card with headers
- Each result shows appropriate row type icon and dimension color
- Selecting a permission result enters upstream subgraph
- Selecting a type result enters downstream subgraph
- Empty input shows recently visited nodes
- Arrow keys, Enter, Esc work for keyboard navigation
</verification>

<success_criteria>
1. fuse.js installed and used for fuzzy matching
2. Abbreviated input matches correctly (e.g., "dv" -> "document#can_view")
3. Results grouped by type card with visual indicators
4. Result selection enters subgraph (upstream for permissions/relations, downstream for types)
5. Recently visited shown on empty input
6. Full keyboard navigation
7. Build and lint pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-interaction-polish/02-05-SUMMARY.md`
</output>
