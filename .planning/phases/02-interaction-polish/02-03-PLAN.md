---
phase: 02-interaction-polish
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - src/canvas/nodes/TypeCardNode.tsx
  - src/canvas/FgaGraph.tsx
  - src/canvas/edges/DimensionEdge.tsx
  - src/canvas/fgaToFlow.ts
autonomous: true
requirements: [INT-03, INT-04, INT-06, VIZ-09, PATH-03]

must_haves:
  truths:
    - "Clicking a permission row enters upstream subgraph -- non-relevant cards fade out, remaining cards animate to new ELK positions"
    - "Clicking a card header enters downstream subgraph -- same two-phase animation"
    - "Double-clicking a card header collapses it to header-only and triggers ELK re-layout"
    - "Single-click vs double-click conflict resolved with 250ms delay pattern"
    - "Non-relevant cards fade out (opacity 0) before removal and re-layout"
    - "Edges connected to fading cards also fade to 0 during phase 1"
    - "Remaining cards animate smoothly to new positions via CSS transform transition"
    - "After transition, viewport auto-fits to show all remaining cards centered"
    - "In subgraph, irrelevant rows are dimmed at ~40% opacity"
    - "Toggle available to hide dimmed rows entirely for compact view"
    - "Self-referencing dimensions show info icon with tooltip on binding rows"
    - "Rapid navigation is guarded with transition ID counter to prevent race conditions"
  artifacts:
    - path: "src/canvas/nodes/TypeCardNode.tsx"
      provides: "Click-to-navigate handlers, double-click collapse, row dimming, self-referencing tooltip"
    - path: "src/canvas/FgaGraph.tsx"
      provides: "Two-phase animation orchestration, transition guards, subgraph-aware node/edge filtering"
    - path: "src/canvas/edges/DimensionEdge.tsx"
      provides: "Edge opacity sync during card fade-out transitions"
  key_links:
    - from: "src/canvas/nodes/TypeCardNode.tsx"
      to: "src/store/viewer-store.ts"
      via: "navigateToSubgraph, toggleCardCollapse store actions"
      pattern: "navigateToSubgraph|toggleCardCollapse"
    - from: "src/canvas/FgaGraph.tsx"
      to: "src/store/viewer-store.ts"
      via: "navigationStack subscription for subgraph filtering"
      pattern: "navigationStack"
    - from: "src/canvas/FgaGraph.tsx"
      to: "src/layout/elk-layout.ts"
      via: "getLayoutedElements re-layout after subgraph change"
      pattern: "getLayoutedElements"
---

<objective>
Wire the subgraph navigation UI: click handlers on TypeCardNode for upstream/downstream navigation and double-click collapse, two-phase animated transitions in FgaGraph, row dimming in subgraph view, edge fade sync, and self-referencing dimension tooltips.

Purpose: This is the core interactive feature of Phase 2 -- subgraph exploration via clicking. It connects the navigation stack (Plan 02-02) to the visual rendering pipeline.

Output: Fully functional subgraph navigation with animated transitions, card collapse, row dimming, and self-referencing dimension indicators.
</objective>

<execution_context>
@/Users/thedoc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thedoc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interaction-polish/02-CONTEXT.md
@.planning/phases/02-interaction-polish/02-RESEARCH.md
@.planning/phases/02-interaction-polish/02-01-SUMMARY.md
@.planning/phases/02-interaction-polish/02-02-SUMMARY.md

@src/canvas/nodes/TypeCardNode.tsx
@src/canvas/FgaGraph.tsx
@src/canvas/edges/DimensionEdge.tsx
@src/canvas/fgaToFlow.ts
@src/store/viewer-store.ts
@src/types.ts
@src/layout/elk-layout.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeCardNode click handlers, collapse, row dimming, and self-referencing tooltips</name>
  <files>
    src/canvas/nodes/TypeCardNode.tsx
  </files>
  <action>
    **Single-click vs double-click conflict resolution:**
    - Add a `clickTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null)` to track pending single-clicks.
    - On header `onClick`: set a 250ms timer. If no second click arrives within 250ms, fire `navigateToSubgraph(d.typeName, 'downstream')`.
    - On header `onDoubleClick`: cancel the pending timer (`clearTimeout`), fire `toggleCardCollapse(d.typeName)`.
    - This prevents both actions firing on double-click.

    **Permission row click-to-navigate:**
    - On RowItem: add an `onClick` handler that calls `navigateToSubgraph(row.id, 'upstream')`.
    - Only fire for permission rows (`row.section === 'permission'`). Binding and relation rows do not navigate on click.
    - Add `cursor: pointer` style to permission rows.
    - Pass `navigateToSubgraph` from the store down to RowItem component.

    **Card collapse rendering:**
    - Subscribe to `collapsedCards` from viewer-store: `const collapsedCards = useViewerStore((s) => s.collapsedCards);`.
    - If `collapsedCards.has(d.typeName)`, render only the header div (skip all section bands).
    - In collapsed header, show the row count: `({d.rows.length})` in muted text next to the type name.
    - The ELK re-layout after collapse will be triggered in FgaGraph.tsx by detecting dimension changes (Task 2 handles this).

    **Row dimming in subgraph:**
    - Subscribe to navigation stack: `const navStackLength = useViewerStore((s) => s.navigationStack.length);`.
    - Get the current frame's relevant row IDs: `const currentFrame = useViewerStore((s) => s.navigationStack[s.navigationStack.length - 1]);`.
    - Subscribe to `dimmedRowsHidden`: `const dimmedRowsHidden = useViewerStore((s) => s.dimmedRowsHidden);`.
    - Pass `isRelevant` down to RowItem: `currentFrame ? currentFrame.relevantRowIds.has(row.id) : true`.
    - In RowItem: if not relevant, apply `opacity: 0.4` style.
    - If `dimmedRowsHidden && !isRelevant`, return `null` (skip rendering entirely).
    - **Zustand selector safety:** Use individual selectors for `navStackLength` (primitive) and the current frame (object). The frame reference is stable within a navigation action, so `Object.is` will correctly detect changes.

    **Self-referencing dimension tooltip:**
    - Subscribe to `selfReferencingDimensions` from viewer-store.
    - For binding rows: check if any self-referencing dimension matches the row's dimension name AND the card's type name.
    - If match found, render a small info icon (SVG `i` circle, ~12px) after the row name.
    - Tooltip via CSS `::after` pseudo-element or a `title` attribute on a wrapper span showing the tooltip text from `SelfReferencingDimension.tooltip`.
    - Use CSS-only tooltip (no tooltip library per research). A `title` attribute is the simplest approach for now.

    **Important constraints:**
    - Keep `React.memo` on both TypeCardNode and RowItem.
    - Keep all existing hover event handlers unchanged.
    - Use `useCallback` for all new event handlers.
    - Import `navigateToSubgraph` and `toggleCardCollapse` from viewer-store using individual selectors.
  </action>
  <verify>
    Run `npm run build` -- must compile without errors.
    Run `npm run lint` -- must pass.
  </verify>
  <done>
    TypeCardNode has: single-click header navigates downstream (250ms delay), double-click header collapses, permission row click navigates upstream, row dimming in subgraph view, self-referencing dimension info icon. All handlers use useCallback. React.memo preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Two-phase animated transition orchestration in FgaGraph</name>
  <files>
    src/canvas/FgaGraph.tsx
    src/canvas/edges/DimensionEdge.tsx
    src/canvas/fgaToFlow.ts
  </files>
  <action>
    **Navigation-aware rendering in FgaGraph.tsx:**
    - Subscribe to navigation stack length: `const navStackLength = useViewerStore((s) => s.navigationStack.length);`.
    - Subscribe to collapsed cards: `const collapsedCards = useViewerStore((s) => s.collapsedCards);`.
    - Get the current frame: derive `currentVisibleTypeIds` from the top of the navigation stack. When `navStackLength > 0`, get `useViewerStore.getState().navigationStack[navStackLength - 1].visibleTypeIds`. At overview level (stack empty), all types are visible.

    **Two-phase transition orchestration:**
    Add a `transitionIdRef = useRef(0)` to guard against rapid navigation.

    When `navStackLength` changes (useEffect dependency), trigger the two-phase animation:

    **Phase 1 - Fade out (150ms):**
    - Increment `transitionIdRef.current`.
    - Capture the current `transitionId`.
    - Set opacity to 0 on nodes NOT in `currentVisibleTypeIds`:
      ```typescript
      setNodes((nodes) =>
        nodes.map((n) => ({
          ...n,
          style: {
            ...n.style,
            opacity: currentVisibleTypeIds.has(n.id) ? 1 : 0,
            transition: 'opacity 150ms ease-out',
          },
        }))
      );
      ```
    - Simultaneously set edge opacity to 0 for edges touching non-visible nodes:
      ```typescript
      setEdges((edges) =>
        edges.map((e) => ({
          ...e,
          style: {
            ...e.style,
            opacity: (currentVisibleTypeIds.has(e.source) && currentVisibleTypeIds.has(e.target)) ? 1 : 0,
            transition: 'opacity 150ms ease-out',
          },
        }))
      );
      ```

    **Phase 2 - Re-layout (after 180ms timeout):**
    - Check `if (transitionIdRef.current !== transitionId) return;` to abort if another navigation happened.
    - Filter nodes to only `currentVisibleTypeIds` members.
    - Filter edges to only those where both source and target are in `currentVisibleTypeIds`.
    - Reset opacity to 1 on remaining nodes.
    - Run `getLayoutedElements()` on the filtered subset.
    - Set the laid-out nodes/edges. CSS `transform 300ms` transition (already in index.css) will animate position changes.
    - After 350ms (wait for position animation), call `reactFlow.fitView({ duration: 200, padding: 0.08 })`.

    **Overview return (navStackLength becomes 0):**
    - When returning to overview, run the reverse: fade in all cards at their original positions.
    - Rebuild full flow elements from the visible graph (same as initial render path).
    - Trigger ELK layout on the full set.
    - This is equivalent to a fresh layout -- reset `layoutDone.current = false` and let the existing layout effect handle it.

    **Card collapse re-layout:**
    - When `collapsedCards` set changes (track via ref), the card dimensions change.
    - After React re-renders the collapsed/expanded card, wait one `requestAnimationFrame`, then trigger ELK re-layout.
    - This ensures `node.measured` reflects the new collapsed height before ELK runs.
    - Use a separate effect watching `collapsedCards` (via `collapsedCards.size` or similar).

    **Disable click handlers during transition:**
    - Track `isTransitioning` state (ref, not Zustand state -- avoid re-renders).
    - Set `true` at start of Phase 1, `false` after Phase 2 completes + fitView.
    - TypeCardNode click handlers should check this ref before navigating.
    - Expose via a simple module-level variable or pass down via React context. Simplest: export a `getIsTransitioning()` function from FgaGraph or a shared module.

    **Edge opacity sync (src/canvas/edges/DimensionEdge.tsx):**
    - DimensionEdge already reads `style.opacity` from the edge object if provided.
    - Ensure the edge component respects the `style.opacity` set during Phase 1 fade-out.
    - If it currently overrides opacity based on hover state, ensure the transition opacity takes precedence during transitions.
    - Check: the edge component may set its own `opacity` via `useEdgeInteraction` or inline. During transitions, the edge-level `style.opacity` from FgaGraph should win.

    **fgaToFlow.ts adjustments (src/canvas/fgaToFlow.ts):**
    - No structural changes needed. The existing `toFlowElements()` already produces all cards and all cross-card edges.
    - The subgraph filtering (which cards/edges to show) happens in FgaGraph.tsx at the React Flow level, not in `toFlowElements()`.

    **Important constraints:**
    - Do NOT use JS animation libraries -- CSS transitions only.
    - Do NOT use `d3-timer` or `framer-motion`.
    - The existing CSS `transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1)` on `.react-flow__node` handles position animation.
    - Use `setTimeout` for phase sequencing with the `transitionId` guard pattern.
    - The ELK layout cache key includes node IDs and edge IDs, so subgraph layouts will compute fresh results (no stale cache hits).
  </action>
  <verify>
    Run `npm run build` -- must compile without errors.
    Run `npm run lint` -- must pass.
    Manually test: clicking a permission row should fade out non-relevant cards, then remaining cards should smoothly animate to new positions.
  </verify>
  <done>
    FgaGraph orchestrates two-phase animated transitions on subgraph navigation. Cards fade out (150ms), remaining cards re-layout and animate to new positions (300ms CSS transition), viewport auto-fits. Card collapse triggers re-layout after dimension change. Transition guard prevents race conditions on rapid navigation. Edges fade in sync with their endpoint cards.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with zero errors
- `npm run lint` passes clean
- Clicking a permission row fades out non-relevant cards and re-lays out remaining
- Clicking a card header fades out non-relevant cards and shows downstream subgraph
- Double-clicking a card header collapses it to header-only
- Single-click and double-click do not conflict
- Irrelevant rows in subgraph are dimmed at ~40% opacity
- Self-referencing binding rows show info icon with tooltip
- Rapid clicking does not cause visual glitches (transition guard works)
- After transition, viewport auto-fits to remaining cards
</verification>

<success_criteria>
1. Permission row click enters upstream subgraph with two-phase animation
2. Card header click enters downstream subgraph with two-phase animation
3. Card header double-click collapses to header-only with re-layout
4. Row dimming works correctly (40% opacity for irrelevant, hidden when toggle active)
5. Self-referencing dimension info icon renders on matching binding rows
6. Transition guard prevents race conditions on rapid navigation
7. Build and lint pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-interaction-polish/02-03-SUMMARY.md`
</output>
