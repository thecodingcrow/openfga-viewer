---
phase: 03-visual-refinement
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/editor/fga-theme.ts
  - src/editor/EditorPanel.tsx
  - src/inspect/InspectPanel.tsx
  - src/toolbar/Toolbar.tsx
  - src/toolbar/CommandPalette.tsx
autonomous: true
requirements:
  - THEME-06
  - THEME-07
  - THEME-08
  - THEME-09

must_haves:
  truths:
    - "Editor syntax highlighting uses muted/desaturated colors -- no bright neon purples, cyans, or greens"
    - "Toolbar is docked to the right side as a vertical bar -- not bottom-center horizontal pill"
    - "Inspector panel uses warm tokens with no per-type rainbow colors"
    - "Command palette uses warm tokens with no per-type rainbow dots"
  artifacts:
    - path: "src/editor/fga-theme.ts"
      provides: "Muted syntax highlight theme using var(--color-*) and desaturated token colors"
    - path: "src/toolbar/Toolbar.tsx"
      provides: "Right-docked vertical toolbar bar"
    - path: "src/inspect/InspectPanel.tsx"
      provides: "Warm-themed tree view with no type colors"
    - path: "src/toolbar/CommandPalette.tsx"
      provides: "Warm-themed search with accent dots instead of type colors"
  key_links:
    - from: "src/toolbar/Toolbar.tsx"
      to: "src/toolbar/CommandPalette.tsx"
      via: "CommandPalette rendered as sibling inside Toolbar -- must remain fixed-position independent of toolbar location"
      pattern: "CommandPalette"
    - from: "src/editor/fga-theme.ts"
      to: "src/editor/EditorPanel.tsx"
      via: "Theme extension imported and applied to CodeMirror instance"
      pattern: "fgaTheme"
---

<objective>
Restyle the editor (muted syntax highlighting), inspector panel (warm tokens, no type colors), and toolbar (right-docked vertical bar). These three surfaces are independent of the canvas/card work in Plan 02 and can be done in parallel.

Purpose: Complete the visual refinement across all non-canvas surfaces. The editor's bright neon syntax colors, the inspector's blue tint, and the toolbar's bottom-center pill layout are the remaining AI slop.

Output: Editor with desaturated syntax colors, inspector with warm neutral tree view, toolbar as a right-docked vertical dock.
</objective>

<execution_context>
@/Users/thedoc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thedoc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-visual-refinement/03-RESEARCH.md
@.planning/phases/03-visual-refinement/03-01-SUMMARY.md
@src/editor/fga-theme.ts
@src/editor/EditorPanel.tsx
@src/toolbar/Toolbar.tsx
@src/toolbar/CommandPalette.tsx
@src/inspect/InspectPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Muted editor syntax highlighting theme</name>
  <files>
    src/editor/fga-theme.ts
    src/editor/EditorPanel.tsx
  </files>
  <action>
**Rewrite `fga-theme.ts` editor theme:**

Replace the `EditorView.theme()` definition to use CSS variable references for all structural colors:

```typescript
EditorView.theme({
  "&": {
    backgroundColor: "var(--color-surface)",
    color: "var(--color-text-secondary)",
    fontSize: "0.8125rem",  // text-[13px] equivalent -- acceptable since it's CodeMirror config, not Tailwind class
    fontFamily: 'ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace',
  },
  ".cm-gutters": {
    backgroundColor: "transparent",
    color: "var(--color-text-muted)",
    border: "none",
  },
  ".cm-activeLineGutter": {
    backgroundColor: "transparent",
  },
  ".cm-activeLine": {
    backgroundColor: "rgba(212, 160, 23, 0.04)",  // very subtle accent highlight
  },
  ".cm-cursor": {
    borderLeftColor: "var(--color-accent)",
  },
  ".cm-selectionBackground": {
    backgroundColor: "rgba(212, 160, 23, 0.12) !important",
  },
  "&.cm-focused .cm-selectionBackground": {
    backgroundColor: "rgba(212, 160, 23, 0.15) !important",
  },
  ".cm-matchingBracket": {
    backgroundColor: "rgba(212, 160, 23, 0.2)",
    color: "var(--color-text-primary) !important",
  },
}, { dark: true })
```

**Replace syntax highlight colors with muted/desaturated palette:**

Replace the `HighlightStyle.define()` colors. Target direction: GitHub Dark / One Dark Pro but lower saturation. Proposed muted palette:

| Token | Current (bright) | New (muted) |
|-------|-------------------|-------------|
| keyword (`define`, `type`, `and`, `or`, `but not`, `from`) | bright purple ~`#c084fc` | `#b098d4` (dusty lavender) |
| typeName (FGA type references) | bright cyan ~`#7dd3fc` | `#ebebeb` (primary text -- types are primary content) |
| variableName (relation names) | bright cyan ~`#67e8f9` | `#9cc4c4` (muted teal) |
| operator (`:`, `[`, `]`, `#`) | bright orange ~`#fb923c` | `#c8a070` (warm sand) |
| bracket | bright yellow ~`#fbbf24` | `#a0a0a0` (neutral) |
| number | bright green ~`#34d399` | `#8fb8a0` (sage) |
| comment (`//`) | slate ~`#64748b` | `#666666` (warm muted) |
| string | bright green ~`#86efac` | `#a4c99e` (soft green) |

Claude's discretion on exact hex values within the "muted/desaturated" constraint. The key rule: NO bright neon colors. Everything should look like it belongs in a professional code editor, not a candy store.

**Update `EditorPanel.tsx`:**

Ensure the panel container background, borders, tab styling all reference `var(--color-*)` tokens. The tab bar should use warm neutral tones. Active tab indicator should use `var(--color-accent)`. The panel background should be `var(--color-surface)`. Borders should be `var(--color-border)`.

Replace any remaining hardcoded hex or `blueprint.*` references (should already be done in Plan 01, but verify completeness).
  </action>
  <verify>
`npm run build` passes. Open the editor panel in browser -- syntax colors should be muted and warm. Keywords are dusty lavender, type names are primary text color, operators are warm sand. No bright neon colors. Editor background matches the warm dark surface.
  </verify>
  <done>
Editor uses muted/desaturated syntax highlighting. All editor structural colors reference CSS variables. EditorPanel uses warm tokens. No bright neon colors in syntax highlighting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Right-docked vertical toolbar</name>
  <files>
    src/toolbar/Toolbar.tsx
  </files>
  <action>
**Rebuild the toolbar layout from horizontal bottom-center pill to right-docked vertical bar:**

The toolbar currently uses `absolute bottom-6 left-1/2 -translate-x-1/2` (bottom center, pill shape with `borderRadius: 9999px`).

Replace with a right-docked vertical layout:

```tsx
<div
  className="absolute right-3 top-1/2 -translate-y-1/2 z-50 flex flex-col items-center gap-1 px-1.5 py-2"
  style={{
    background: "var(--color-surface-overlay)",
    border: "1px solid var(--color-border)",
    borderRadius: 8,
  }}
>
```

**Changes to make:**
1. Position: `right-3 top-1/2 -translate-y-1/2` (centered vertically on right edge).
2. Layout: `flex-col` instead of `flex` (vertical stack).
3. Border radius: `8px` instead of `9999px` (sharp/professional, not squishy pill).
4. Background: `var(--color-surface-overlay)` with `var(--color-border)` border.
5. Remove the `.hud-panel` class from the toolbar div -- use inline styles for the specific toolbar appearance.

**Separator component:** Change from vertical divider (`w-px h-5`) to horizontal divider (`h-px w-5`).

**ToolbarButton component:** Update the hover/active styles:
- Active: `color: var(--color-accent)`, background `rgba(212, 160, 23, 0.08)`, border `1px solid rgba(212, 160, 23, 0.25)`.
- Hover (non-active): background `rgba(212, 160, 23, 0.05)`.
- Default: `color: var(--color-text-secondary)`.

**CommandPalette positioning:** The CommandPalette is rendered as a sibling `<CommandPalette>` component at the bottom of the Toolbar return. It uses `fixed` positioning (top: 20vh, centered). Verify it is NOT affected by the toolbar position change. It should still render centered in the viewport.

**Hidden file input:** Keep the `<input type="file">` as-is (it's hidden).
  </action>
  <verify>
`npm run build` passes. Load app in browser -- toolbar appears as a vertical dock on the right edge, centered vertically. Icons stack vertically with horizontal separators. CommandPalette (Cmd+K) still opens centered in viewport, not shifted by toolbar position. All toolbar button hover/active states work.
  </verify>
  <done>
Toolbar is right-docked vertical bar with sharp 8px radius. Icons stack vertically. Separators are horizontal. CommandPalette positioning is unaffected. All interactive states use warm accent tokens.
  </done>
</task>

<task type="auto">
  <name>Task 3: Inspector and command palette warm restyle</name>
  <files>
    src/inspect/InspectPanel.tsx
    src/toolbar/CommandPalette.tsx
  </files>
  <action>
**InspectPanel (`InspectPanel.tsx`):**

1. Replace all remaining hardcoded hex or rgba colors with `var(--color-*)` token references.
2. Remove any `getTypeColor()` usage -- replace per-type colored dots with `var(--color-accent)` for type-level items, or neutral section dots for row items.
3. Tree node styling: background on hover `rgba(212, 160, 23, 0.06)`, selected/active `rgba(212, 160, 23, 0.12)`.
4. Tree text: primary items `var(--color-text-primary)`, secondary `var(--color-text-secondary)`, muted `var(--color-text-muted)`.
5. Panel background: `var(--color-surface)`, border: `var(--color-border)`.
6. Filter input: background `var(--color-surface-raised)`, border `var(--color-border-subtle)`, text `var(--color-text-secondary)`, placeholder `var(--color-text-muted)`.
7. Expand/collapse arrows: `var(--color-text-muted)`.

**CommandPalette (`CommandPalette.tsx`):**

1. Replace all remaining hardcoded hex or rgba colors with `var(--color-*)` token references.
2. Remove any `getTypeColor()` usage -- replace per-type colored dots with `var(--color-accent)` for all type-level items.
3. Search input: background `var(--color-surface-raised)`, border `var(--color-border)`, text `var(--color-text-primary)`, placeholder `var(--color-text-muted)`.
4. Result items: background on hover/selected `rgba(212, 160, 23, 0.08)`, text `var(--color-text-secondary)`, matched chars highlight `var(--color-accent)`.
5. Group headers: `var(--color-text-muted)`, separator `var(--color-border-subtle)`.
6. Recently visited items: same warm styling.
7. Keyboard shortcut badges (if any remain): `var(--color-text-muted)` text, `var(--color-border-subtle)` border.
8. Modal backdrop: keep dark overlay. Modal panel: `var(--color-surface-overlay)`, border `var(--color-border)`.
  </action>
  <verify>
`npm run build` passes. Open inspector panel -- tree view uses warm tones, no per-type colors. Open command palette (Cmd+K) -- search results use warm tones, type dots use accent color instead of rainbow. Both panels feel cohesive with the rest of the warm dark theme.
  </verify>
  <done>
Inspector panel uses warm tokens throughout with no per-type rainbow colors. Command palette uses warm tokens with accent-colored dots. Both panels are visually cohesive with the warm dark theme.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Editor syntax uses muted/desaturated colors (no bright neon)
3. Toolbar is docked to right side, vertical layout
4. CommandPalette still opens centered in viewport
5. Inspector tree view has no per-type colors
6. Command palette search results have no per-type colors
7. All panels use consistent warm token palette
8. `grep -r "getTypeColor" src/` returns nothing
</verification>

<success_criteria>
- Editor syntax highlighting is muted and professional
- Toolbar is a right-docked vertical bar
- Inspector and command palette use warm tokens exclusively
- No per-type rainbow colors in any panel
- All surfaces feel cohesive with the warm dark theme
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-refinement/03-03-SUMMARY.md`
</output>
