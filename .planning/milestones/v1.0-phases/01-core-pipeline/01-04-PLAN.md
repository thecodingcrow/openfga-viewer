---
phase: 01-core-pipeline
plan: 04
type: execute
wave: 4
depends_on:
  - "01-03"
files_modified:
  - src/store/hover-store.ts
  - src/store/viewer-store.ts
  - src/graph/traversal.ts
  - src/canvas/FgaGraph.tsx
  - src/canvas/nodes/TypeCardNode.tsx
  - src/canvas/edges/DimensionEdge.tsx
  - src/index.css
autonomous: true
requirements:
  - INT-01
  - INT-02

must_haves:
  truths:
    - "Hovering a permission row highlights upstream feeding paths without layout change"
    - "Hovering a card header highlights downstream enabled paths without layout change"
    - "Non-participating nodes and edges dim to ~25% opacity during hover"
    - "Participating rows get a subtle background tint within their card"
    - "Fast fade transition (~100-150ms) on hover state changes"
    - "Old node components (TypeNode, RelationNode, PermissionNode) are deleted"
    - "Old edge components (DirectEdge, ComputedEdge, TuplesetDepEdge) are deleted"
    - "Old conversion (fgaToFlow exports) and old layout (3-pass) are gone"
    - "npm run build passes with no errors"
    - "npm run lint passes"
  artifacts:
    - path: "src/store/hover-store.ts"
      provides: "Row-level hover state with upstream/downstream BFS path computation"
      exports: ["useHoverStore"]
    - path: "src/store/viewer-store.ts"
      provides: "Updated store with dimensions state"
    - path: "src/graph/traversal.ts"
      provides: "Updated traversal with cross-card-only BFS functions"
  key_links:
    - from: "src/store/hover-store.ts"
      to: "src/graph/traversal.ts"
      via: "calls traceUpstream/traceDownstream BFS functions"
      pattern: "traceUpstream|traceDownstream"
    - from: "src/canvas/nodes/TypeCardNode.tsx"
      to: "src/store/hover-store.ts"
      via: "reads highlight state to dim/tint rows"
      pattern: "useHoverStore"
    - from: "src/canvas/edges/DimensionEdge.tsx"
      to: "src/store/hover-store.ts"
      via: "reads highlight state to dim edges"
      pattern: "useHoverStore"
    - from: "src/canvas/FgaGraph.tsx"
      to: "src/store/hover-store.ts"
      via: "row-level hover events from card mouse handlers"
      pattern: "setHoveredRow|setHoveredCard"
---

<objective>
Implement row-level hover highlighting (upstream from permission rows, downstream from card headers), update stores with dimension awareness, wire hover events from cards through to visual dimming, and delete the entire old pipeline.

Purpose: This is the final plan — it makes the graph interactive (hover exploration) and removes all dead code from the old compound pipeline. After this plan, Phase 1 success criteria are fully met.

Output: Rewritten hover-store with row-level BFS, updated viewer-store with dimensions, updated traversal with new BFS functions, hover-aware TypeCardNode and DimensionEdge, deleted old files, passing build and lint.
</objective>

<execution_context>
@/Users/thedoc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thedoc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-pipeline/01-RESEARCH.md
@.planning/phases/01-core-pipeline/01-CONTEXT.md
@.planning/phases/01-core-pipeline/01-03-SUMMARY.md

@src/store/hover-store.ts
@src/store/viewer-store.ts
@src/graph/traversal.ts
@src/canvas/FgaGraph.tsx
@src/canvas/nodes/TypeCardNode.tsx
@src/canvas/edges/DimensionEdge.tsx
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement row-level hover highlighting with BFS traversal</name>
  <files>src/graph/traversal.ts, src/store/hover-store.ts, src/store/viewer-store.ts, src/canvas/nodes/TypeCardNode.tsx, src/canvas/edges/DimensionEdge.tsx, src/canvas/FgaGraph.tsx, src/index.css</files>
  <action>
**Update `src/graph/traversal.ts`** — add two new exported functions:

1. `traceUpstream(startRowId: string, edges: AuthorizationEdge[]): { nodeIds: Set<string>; edgeIds: Set<string>; rowIds: Set<string> }` — BFS backward through cross-card edges only (`rewriteRule === 'direct'` or `rewriteRule === 'ttu'`). Start from `startRowId`, follow edges where `edge.target === currentId`, collect `edge.source` into queue. Return all visited node IDs, edge IDs, and row IDs (same as node IDs in this model since edges connect relation-level nodes).

2. `traceDownstream(startTypeId: string, nodes: AuthorizationNode[], edges: AuthorizationEdge[]): { nodeIds: Set<string>; edgeIds: Set<string>; rowIds: Set<string> }` — BFS forward from ALL relations/permissions belonging to the given type. First collect all node IDs where `node.type === startTypeId && node.kind !== 'type'`. Then BFS forward through cross-card edges: follow edges where `edge.source === currentId`, collect `edge.target` into queue. Return all visited IDs.

Keep all existing traversal functions — they may still be used by the store for focus mode/path tracing.

**Rewrite `src/store/hover-store.ts`:**

Replace the existing hover store with a new row-level hover model:

```typescript
interface HoverStore {
  // Current hover state
  hoveredRowId: string | null;       // hovered permission row (for upstream trace)
  hoveredCardTypeId: string | null;  // hovered card header (for downstream trace)

  // Pre-computed highlight sets (avoid recomputation in each component)
  highlightedNodeIds: Set<string>;
  highlightedEdgeIds: Set<string>;
  highlightedRowIds: Set<string>;

  // Whether any hover is active (for dimming logic)
  isHoverActive: boolean;

  // Actions
  setHoveredRow: (rowId: string | null, edges: AuthorizationEdge[]) => void;
  setHoveredCard: (typeId: string | null, nodes: AuthorizationNode[], edges: AuthorizationEdge[]) => void;
  clearHover: () => void;
}
```

Implementation:
- `setHoveredRow(rowId, edges)`: if `rowId` is null, clear all. Otherwise call `traceUpstream(rowId, edges)` and store the result sets. Set `isHoverActive = true`.
- `setHoveredCard(typeId, nodes, edges)`: if `typeId` is null, clear all. Otherwise call `traceDownstream(typeId, nodes, edges)` and store the result sets. Set `isHoverActive = true`.
- `clearHover()`: reset all to null/empty/false.

Use individual selectors in components to avoid re-renders — expose stable references for the `Set` objects.

**Update `src/store/viewer-store.ts`:**

Add `dimensions: Map<string, Dimension>` to the store interface (initially empty Map). After `parse()` succeeds, compute and store dimensions:
```typescript
import { detectDimensions } from '../dimensions/detect';
import { assignDimensionColors } from '../theme/dimensions';

// Inside parse() success path, after setting nodes/edges:
const rawDimensions = detectDimensions({ nodes, edges });
const dimensions = assignDimensionColors(rawDimensions);
set({ ..., dimensions });
```

Also add `dimensions` to the error reset path (set to `new Map()`).

**Update `src/canvas/nodes/TypeCardNode.tsx`:**

Add hover awareness to the card component:

1. Import `useHoverStore` from the hover store.
2. In the component body, select hover state:
   ```typescript
   const isHoverActive = useHoverStore((s) => s.isHoverActive);
   const highlightedRowIds = useHoverStore((s) => s.highlightedRowIds);
   const highlightedNodeIds = useHoverStore((s) => s.highlightedNodeIds);
   ```
3. Determine if this card participates in the current hover:
   - Card participates if ANY of its row IDs are in `highlightedRowIds`, or if the type node ID is in `highlightedNodeIds`
   - If `isHoverActive && !cardParticipates`: dim the entire card to `opacity: 0.25`
   - If `isHoverActive && cardParticipates`: card stays at full opacity
4. For individual rows: if `isHoverActive && highlightedRowIds.has(row.id)`, add a subtle background tint (`rgba(136, 204, 238, 0.08)` — very faint cyan, per locked decision "subtle background tint on participating rows").
5. Add mouse event handlers for hover triggering:
   - On permission/relation rows: `onMouseEnter` calls `setHoveredRow(row.id, edges)` from hover store
   - On card header: `onMouseEnter` calls `setHoveredCard(typeName, nodes, edges)` from hover store
   - On card `onMouseLeave`: calls `clearHover()`

To get the `edges` and `nodes` data needed for the BFS, the card can either:
  - Read `edges` from `useViewerStore((s) => s.edges)` (full edge set for BFS)
  - Read `nodes` from `useViewerStore((s) => s.nodes)` (full node set for downstream)

  These are stable references (only change on parse), so they won't cause excess re-renders.

**Update `src/canvas/edges/DimensionEdge.tsx`:**

Add hover-based dimming:
1. Import `useHoverStore`
2. Select: `isHoverActive`, `highlightedEdgeIds`
3. Compute opacity: if `isHoverActive && !highlightedEdgeIds.has(edgeId)` → opacity `0.08` (very dim). If highlighted → use base opacity `0.6`. If no hover active → use base opacity `0.6`.
4. Apply opacity to the edge rendering (stroke-opacity on the path element).

**Update `src/canvas/FgaGraph.tsx`:**

Remove the old node-level hover handlers (`onNodeMouseEnter`, `onNodeMouseLeave` that called `setHoveredNode`). The hover is now triggered from within the TypeCardNode component itself (row-level events). Remove the `setHoveredNode` import from `useHoverStore`. Remove the `fullEdges` selector if it was only used for hover.

Keep `onPaneClick` — add `clearHover()` call alongside existing logic.

**Update `src/index.css`:**

Add CSS transition for hover dimming on cards and edges:
```css
.react-flow__node {
  transition: opacity 120ms ease-out;
}
```
The edge opacity transition should already exist from the current CSS. Verify the edge transition covers `stroke-opacity` and `opacity` with ~120-150ms duration. Adjust if needed.
  </action>
  <verify>
`npm run build` succeeds. Load the app, hover over a permission row — upstream cards/edges should highlight, non-participating elements dim. Hover over a card header — downstream elements highlight. Moving mouse off the card clears the hover. Transition is smooth (~120ms).
  </verify>
  <done>
Row-level hover triggers upstream BFS from permission rows and downstream BFS from card headers. Non-participating elements dim to ~25% opacity. Participating rows get subtle background tint. Transitions are fast (~120ms). Hover state is computed once in the store and consumed reactively by card and edge components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete old pipeline files and verify clean build</name>
  <files>
    src/canvas/nodes/TypeNode.tsx (DELETE)
    src/canvas/nodes/RelationNode.tsx (DELETE)
    src/canvas/nodes/PermissionNode.tsx (DELETE)
    src/canvas/nodes/useNodeInteraction.ts (DELETE)
    src/canvas/edges/DirectEdge.tsx (DELETE)
    src/canvas/edges/ComputedEdge.tsx (DELETE)
    src/canvas/edges/TuplesetDepEdge.tsx (DELETE)
    src/canvas/edges/useEdgeInteraction.ts (DELETE)
  </files>
  <action>
**Delete these 8 files** (the entire old visual pipeline):

Old node components:
- `src/canvas/nodes/TypeNode.tsx`
- `src/canvas/nodes/RelationNode.tsx`
- `src/canvas/nodes/PermissionNode.tsx`
- `src/canvas/nodes/useNodeInteraction.ts`

Old edge components:
- `src/canvas/edges/DirectEdge.tsx`
- `src/canvas/edges/ComputedEdge.tsx`
- `src/canvas/edges/TuplesetDepEdge.tsx`
- `src/canvas/edges/useEdgeInteraction.ts`

**After deletion, verify no remaining imports reference deleted files:**

1. Run `grep -r "TypeNode\|RelationNode\|PermissionNode\|useNodeInteraction" src/` — should return zero matches (excluding this plan file or any `.md` files)
2. Run `grep -r "DirectEdge\|ComputedEdge\|TuplesetDepEdge\|useEdgeInteraction" src/` — should return zero matches
3. Run `grep -r "edgeDirect\|edgeComputed\|edgeTuplesetDep" src/` — should return zero matches (old blueprint colors)
4. If any dangling imports found, remove them.

**Also check `src/canvas/Breadcrumb.tsx`** — if it exists, check if it imports deleted modules. If it only references the store (no deleted components), leave it. If it references deleted components, remove those imports.

**Final verification:**
- `npm run build` — must pass with zero errors
- `npm run lint` — must pass (fix any lint issues in modified files)
- No TypeScript errors, no unused imports in modified files

**Clean up any unused imports in the viewer store or hover store** that reference old patterns (e.g., `expandViaTtu` import if it's no longer called from the hover store).
  </action>
  <verify>
`npm run build` passes. `npm run lint` passes. `grep -r "TypeNode\|RelationNode\|PermissionNode" src/ --include="*.ts" --include="*.tsx"` returns only TypeCardNode references. No dangling imports to deleted files.
  </verify>
  <done>
All 8 old pipeline files deleted. No dangling imports remain. Project builds and lints cleanly. The old compound node/edge pipeline is fully replaced by the new ERD card + dimension edge pipeline.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run lint` passes with zero warnings/errors
3. Hovering a permission row highlights upstream path (cards, edges, rows)
4. Hovering a card header highlights downstream path
5. Non-participating elements dim to ~25% opacity with smooth transition
6. Participating rows show subtle background tint
7. Moving mouse off card clears all highlighting
8. No old pipeline files exist in `src/canvas/nodes/` or `src/canvas/edges/` (only TypeCardNode.tsx and DimensionEdge.tsx)
9. No references to deleted components anywhere in src/
10. App renders the default sample model correctly
</verification>

<success_criteria>
- Hover exploration works bidirectionally: upstream from permission rows, downstream from card headers
- Visual dimming is smooth (120ms transition) and unobtrusive
- All 8 old pipeline files are deleted with no residual references
- Clean build and lint with zero errors
- The app is fully functional with the new ERD card pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-pipeline/01-04-SUMMARY.md`
</output>
