---
phase: 01-core-pipeline
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/canvas/nodes/TypeCardNode.tsx
  - src/canvas/edges/DimensionEdge.tsx
  - src/canvas/fgaToFlow.ts
autonomous: true
requirements:
  - VIZ-01
  - VIZ-02
  - VIZ-03
  - VIZ-08
  - DATA-03
  - DATA-04

must_haves:
  truths:
    - "Each FGA type renders as a single ERD schema card with binding, relation, and permission sections"
    - "Binding rows display a dimension-colored dot indicating which structural dimension they create"
    - "Permission rows display readable expressions with dimension annotation notation"
    - "Cards use dark glass styling with type-colored accent bar"
    - "A single DimensionEdge component renders all cross-card edges"
    - "Same-card dependencies (computed, tupleset-dep) are excluded from visual edges and appear only as expression text"
    - "Flow conversion produces one React Flow node per FGA type, not per relation"
  artifacts:
    - path: "src/canvas/nodes/TypeCardNode.tsx"
      provides: "ERD schema card node component"
      exports: ["TypeCardNode"]
    - path: "src/canvas/edges/DimensionEdge.tsx"
      provides: "Universal edge component for dimension and type-restriction edges"
      exports: ["DimensionEdge"]
    - path: "src/canvas/fgaToFlow.ts"
      provides: "AuthorizationGraph to React Flow elements conversion with card grouping"
      exports: ["toFlowElements"]
  key_links:
    - from: "src/canvas/fgaToFlow.ts"
      to: "src/dimensions/detect.ts"
      via: "calls detectDimensions, classifyEdges, transformExpression"
      pattern: "import.*detect"
    - from: "src/canvas/fgaToFlow.ts"
      to: "src/theme/dimensions.ts"
      via: "calls assignDimensionColors"
      pattern: "assignDimensionColors"
    - from: "src/canvas/nodes/TypeCardNode.tsx"
      to: "src/types.ts"
      via: "uses SchemaCard and CardRow types for node data"
      pattern: "import type.*SchemaCard|CardRow"
    - from: "src/canvas/edges/DimensionEdge.tsx"
      to: "src/theme/dimensions.ts"
      via: "reads TYPE_RESTRICTION_COLOR for type-restriction edges"
      pattern: "TYPE_RESTRICTION_COLOR"
---

<objective>
Build the visual components for the new ERD-card pipeline: a single TypeCardNode that renders an entire FGA type as a schema card, a single DimensionEdge that renders all cross-card edges, and the new fgaToFlow conversion that groups AuthorizationNodes into cards and filters edges.

Purpose: These three files form the rendering heart of the new pipeline. The card replaces three old node components (TypeNode, RelationNode, PermissionNode). The edge replaces three old edge components (DirectEdge, ComputedEdge, TuplesetDepEdge). The conversion replaces the old compound-parent-child logic with flat card grouping.

Output: `TypeCardNode.tsx` (ERD card node), `DimensionEdge.tsx` (universal edge), rewritten `fgaToFlow.ts` (card-based conversion).
</objective>

<execution_context>
@/Users/thedoc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thedoc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-pipeline/01-RESEARCH.md
@.planning/phases/01-core-pipeline/01-CONTEXT.md
@.planning/phases/01-core-pipeline/01-01-SUMMARY.md

@src/types.ts
@src/dimensions/detect.ts
@src/theme/dimensions.ts
@src/theme/colors.ts
@src/canvas/fgaToFlow.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeCardNode ERD schema card component</name>
  <files>src/canvas/nodes/TypeCardNode.tsx</files>
  <action>
Create `src/canvas/nodes/TypeCardNode.tsx` — a React Flow custom node that renders one FGA type as an ERD schema card. Wrap in `React.memo` per project convention.

**Component structure:**

The node receives `data` shaped as `SchemaCard` (from `src/types.ts`). The `[key: string]: unknown` index signature is required for React Flow node data compatibility — add it to the `NodeProps` type assertion.

**Card layout (top to bottom):**
1. **Header** — type name, bold, with accent-colored top border (3px solid, color from `data.accentColor`). Background slightly lighter than card body. Include a hidden `Handle` pair (type=target on top/left, type=source on bottom/right) with ID `{nodeId}__header_target` and `{nodeId}__header_source` for card-level connections. The header should be hoverable for INT-02 (downstream highlight) — add `data-header="true"` attribute.

2. **Section bands** — three sections rendered conditionally (skip empty sections). Each section has a subtly different background shade to create visual banding per CONTEXT.md locked decision:
   - Bindings: `rgba(15, 23, 42, 0.95)` — darkest
   - Relations: `rgba(15, 23, 42, 0.88)` — mid
   - Permissions: `rgba(15, 23, 42, 0.80)` — lightest

3. **Rows within sections** — each row renders:
   - A `Handle` with `type="target"` and `id="{row.id}__target"` (positioned left for LR / top for TB)
   - A uniform small dot (6px circle). For bindings, fill with `row.dimensionColor`. For relations/permissions, fill with `#64748b` (slate-500).
   - Row name in monospace-ish font (`font-mono text-xs`)
   - For permission rows: expression text right-aligned in `text-slate-500` using `row.expression`
   - A `Handle` with `type="source"` and `id="{row.id}__source"` (positioned right for LR / bottom for TB)

**Styling (locked decisions from CONTEXT.md):**
- Card: `rounded-xl`, `overflow-hidden`, dark glass background `rgba(15, 23, 42, 0.85)`, `backdrop-filter: blur(8px)`, subtle border `1px solid rgba(51, 65, 85, 0.5)`
- Compact row density: tight padding (`px-3 py-0.5` for rows, `px-3 py-1.5` for header)
- Content-adaptive width: set `minWidth: 200px`, `maxWidth: 380px`, `width: 'fit-content'` on the card container so React Flow measures actual content width
- No minimum card height — a type with one binding renders as a tiny card

**Handle visibility:** All handles should be visually hidden (`opacity: 0`, `width: 6px`, `height: 6px`) — they exist only for edge connection points, not as visible UI elements. Use `style={{ opacity: 0, width: 6, height: 6 }}` on Handle components.

**Performance:** Wrap component function in `memo()`. Component name pattern: `function TypeCardNodeComponent(...)` exported as `export const TypeCardNode = memo(TypeCardNodeComponent);`
  </action>
  <verify>
`npx tsc --noEmit -- src/canvas/nodes/TypeCardNode.tsx` compiles. Component exports `TypeCardNode`. Component accepts React Flow `NodeProps`. All rows produce unique Handle IDs. Handles are visually hidden.
  </verify>
  <done>
TypeCardNode renders FGA types as ERD cards with dark glass styling, accent bar, three background-banded sections (bindings/relations/permissions), compact rows with dimension-colored dots on bindings, expression text on permissions, and hidden Handle pairs per row for edge attachment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DimensionEdge and rewrite fgaToFlow conversion</name>
  <files>src/canvas/edges/DimensionEdge.tsx, src/canvas/fgaToFlow.ts</files>
  <action>
**Create `src/canvas/edges/DimensionEdge.tsx`:**

A single React Flow custom edge component that renders ALL cross-card edges. Wrap in `React.memo`.

Edge data includes:
- `classification: EdgeClassification` — `'dimension'` or `'type-restriction'`
- `dimensionColor?: string` — the dimension's assigned color (only for dimension edges)
- `elkRoute?: { points: Point[] }` — ELK-computed route if available (added by layout pass in Plan 03)

Rendering logic:
- If `elkRoute` exists, use `elkPointsToPath()` from `../layout/elk-path.ts` + `BaseEdge` from `@xyflow/react`
- Otherwise, use `getSmoothStepPath()` from `@xyflow/react` as fallback (needed before layout runs)
- Stroke color: for `classification === 'dimension'`, use `data.dimensionColor`; for `type-restriction`, use `TYPE_RESTRICTION_COLOR` from `../../theme/dimensions`
- Stroke width: `1.25` (thin, per locked decision ~1-1.5px)
- Stroke opacity: `0.6` (subtle, cards dominate per locked decision)
- All edges solid — no dashed/dotted (locked decision)
- Arrowhead at target end via `markerEnd` — small arrow (width 8, height 8) matching stroke color. Use `MarkerType.ArrowClosed` for clean look.

The component should accept edge data with an `opacity` field that the hover system (Plan 04) will use to dim non-participating edges. Default to the base opacity when not overridden.

Export: `export const DimensionEdge = memo(DimensionEdgeComponent);`

**Rewrite `src/canvas/fgaToFlow.ts`:**

Complete rewrite — delete all existing code. The new module converts `AuthorizationGraph` + dimension data into React Flow nodes (TypeCardNode) and edges (DimensionEdge).

New exports:

1. `toFlowElements(graph: AuthorizationGraph): { nodes: Node[]; edges: Edge[]; dimensions: Map<string, Dimension> }` — the main conversion function:

   a. Call `detectDimensions(graph)` to get raw dimensions
   b. Call `assignDimensionColors(dimensions)` to get colored dimensions
   c. Call `classifyEdges(graph.edges)` to separate cross-card from same-card edges
   d. Group `graph.nodes` by `type` field. For each type:
      - Find the type node (kind === 'type')
      - Collect child nodes (kind !== 'type', same type field)
      - Classify each child: `isTuplesetBinding === true` -> 'binding', `isPermission === true` -> 'permission', else -> 'relation'
      - Sort rows: bindings first, then relations, then permissions (stable order within each section — alphabetical by name)
      - For binding rows: look up dimension color from colored dimensions map using the node's `relation` field
      - For permission rows: call `transformExpression(node.definition)` if definition exists
      - Get type accent color via `getTypeColor(typeName)` from `../../theme/colors`
      - Build `SchemaCard` data and create React Flow node with `type: 'typeCard'`, `position: { x: 0, y: 0 }`, `data: schemaCard`
   e. For cross-card edges only (from `classifyEdges`): create React Flow edges with `type: 'dimension'`, source/target handle IDs using `{edge.source}__source` and `{edge.target}__target`. Edge data includes `classification` and `dimensionColor` (look up from edge's `tuplesetRelation` in dimensions map; `'type-restriction'` for direct edges).
   f. Return `{ nodes, edges, dimensions }`

2. Remove old exports: `toFlowNode`, `toFlowEdge`, `FgaNodeData`, `MARKERS`. These are replaced.

**Important implementation details:**
- Use `import type` for type-only imports
- React Flow requires `[key: string]: unknown` on node data — include this in the SchemaCard type assertion
- Edge IDs remain the same as `AuthorizationEdge.id`
- Source handle: `{edge.source}__source`, Target handle: `{edge.target}__target` — matching the Handle IDs in TypeCardNode
- `toFlowElements` must return the `dimensions` map so the store can hold it for hover highlighting
  </action>
  <verify>
`npx tsc --noEmit -- src/canvas/edges/DimensionEdge.tsx src/canvas/fgaToFlow.ts` compiles. `toFlowElements` returns nodes with type `'typeCard'`, edges with type `'dimension'`, and a dimensions Map. Old exports (`toFlowNode`, `toFlowEdge`, `FgaNodeData`) no longer exist.
  </verify>
  <done>
DimensionEdge renders all cross-card edges with dimension colors or muted slate, thin solid lines, small arrowheads. fgaToFlow groups nodes by type into SchemaCard data, excludes same-card edges, produces dimension-colored cross-card edges, and returns the dimensions map alongside nodes and edges.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` on the three new/modified files compiles (old files that import removed symbols will error — expected, fixed in Plan 03/04)
2. TypeCardNode produces unique Handle IDs per row: `{nodeId}#{relation}__target`, `{nodeId}#{relation}__source`
3. DimensionEdge uses `TYPE_RESTRICTION_COLOR` for direct edges, dimension palette color for TTU edges
4. fgaToFlow produces exactly one React Flow node per unique type in the AuthorizationGraph
5. fgaToFlow excludes computed and tupleset-dep edges from the visual edge output
6. fgaToFlow returns a `dimensions` Map alongside nodes and edges
</verification>

<success_criteria>
- Each FGA type from the sample model becomes one TypeCardNode with correct binding/relation/permission sections
- Binding rows have colored dots matching their dimension assignment
- Permission rows show transformed expressions (e.g., `↗client.can_read | ↗ip_agency.member`)
- Cards have dark glass styling with accent bar matching the type color
- Only direct and TTU edges appear in the edge output — no computed or tupleset-dep edges
- DimensionEdge renders with correct color per edge type
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-pipeline/01-02-SUMMARY.md`
</output>
