---
phase: 03-visual-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.css
  - src/theme/colors.ts
  - src/types.ts
  - src/canvas/fgaToFlow.ts
  - src/canvas/FgaGraph.tsx
  - src/canvas/Canvas.tsx
  - src/canvas/Breadcrumb.tsx
  - src/canvas/nodes/TypeCardNode.tsx
  - src/canvas/edges/DimensionEdge.tsx
  - src/editor/fga-theme.ts
  - src/editor/EditorPanel.tsx
  - src/toolbar/Toolbar.tsx
  - src/toolbar/CommandPalette.tsx
  - src/inspect/InspectPanel.tsx
  - src/components/Tooltip.tsx
  - src/components/ResizeHandle.tsx
  - src/App.tsx
autonomous: true
requirements:
  - THEME-01
  - THEME-02
  - THEME-09

must_haves:
  truths:
    - "Every color in the app derives from CSS custom properties defined in @theme -- no hardcoded hex values in component files"
    - "No per-type rainbow colors exist anywhere -- TYPE_PALETTE, getTypeColor, EXTRA_COLORS, and accentColor are fully removed"
    - "The app uses warm neutral tones (#111, #1a1a territory) with zero blue tint from the old blueprint palette"
  artifacts:
    - path: "src/index.css"
      provides: "Warm dark @theme token palette"
      contains: "--color-bg: #1"
    - path: "src/theme/colors.ts"
      provides: "Only re-exports from dimensions.ts -- no blueprint const, no TYPE_PALETTE, no getTypeColor"
    - path: "src/types.ts"
      provides: "SchemaCard type without accentColor field"
  key_links:
    - from: "src/index.css"
      to: "all component files"
      via: "var(--color-*) references in inline styles and Tailwind utilities"
      pattern: "var\\(--color-"
    - from: "src/canvas/fgaToFlow.ts"
      to: "src/canvas/nodes/TypeCardNode.tsx"
      via: "SchemaCard data no longer carries accentColor"
      pattern: "typeName"
---

<objective>
Define the warm dark design token palette in Tailwind v4 `@theme` and eliminate all legacy color systems (blueprint TS const, TYPE_PALETTE, getTypeColor, accentColor). Every color reference across all 16+ files migrates to CSS custom property references.

Purpose: Establish the single source of truth for all colors. Without this foundation, no visual restyle can happen -- components would still reference cold blue values or per-type rainbow colors.

Output: `index.css` with complete warm token palette, `colors.ts` reduced to dimension re-exports only, `types.ts` without accentColor, and all component files referencing `var(--color-*)` instead of `blueprint.*` or hardcoded hex.
</objective>

<execution_context>
@/Users/thedoc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thedoc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-visual-refinement/03-RESEARCH.md
@src/index.css
@src/theme/colors.ts
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define warm dark token palette and eliminate blueprint const</name>
  <files>
    src/index.css
    src/theme/colors.ts
    src/types.ts
    src/canvas/fgaToFlow.ts
  </files>
  <action>
**1. Replace `@theme` tokens in `src/index.css`:**

Delete the entire existing `@theme { ... }` block and replace with the warm dark palette:

```css
@theme {
  /* Backgrounds */
  --color-bg: #111111;
  --color-surface: #191919;
  --color-surface-raised: #222222;
  --color-surface-overlay: #282828;

  /* Borders */
  --color-border: #2e2e2e;
  --color-border-subtle: #242424;

  /* Text */
  --color-text-primary: #ebebeb;
  --color-text-secondary: #a0a0a0;
  --color-text-muted: #666666;

  /* Accent */
  --color-accent: #d4a017;

  /* Feedback */
  --color-danger: #ef4444;

  /* Canvas */
  --color-dot-grid: #222222;

  /* Section dots (per-section neutral shades) */
  --color-dot-binding: #a0a0a0;
  --color-dot-relation: #777777;
  --color-dot-permission: #555555;
}
```

Update `html, body, #root` to reference `var(--color-bg)` instead of `var(--color-blueprint-bg)`.

Update `.hud-panel` background to `rgba(17, 17, 17, 0.95)` (warm), border to `var(--color-border)`.

Update `.scrollbar-dark` thumb color to `var(--color-border)` and hover to `var(--color-text-muted)`.

**2. Gut `src/theme/colors.ts`:**

Remove the entire `blueprint` const, `TYPE_PALETTE`, `EXTRA_COLORS`, `hashString`, and `getTypeColor`. The file should only contain the dimension re-exports:

```typescript
// Re-export dimension palette for convenient single-import access
export {
  DIMENSION_PALETTE,
  TYPE_RESTRICTION_COLOR,
  assignDimensionColors,
} from "./dimensions";
```

**3. Remove `accentColor` from `SchemaCard` in `src/types.ts`:**

Delete the `accentColor: string;` field and its JSDoc comment from the `SchemaCard` interface.

**4. Remove `accentColor` assignment in `src/canvas/fgaToFlow.ts`:**

Find where `accentColor` is set (it calls `getTypeColor(typeName)`) and remove that line. Remove the `getTypeColor` import from `../theme/colors`. The `SchemaCard` data object should no longer include `accentColor`.
  </action>
  <verify>
Run `npm run build`. The build will fail at this point because ~8 files still import `blueprint` from `../theme/colors` -- that is expected and handled in Task 2. Verify that `src/theme/colors.ts` no longer exports `blueprint`, `TYPE_PALETTE`, or `getTypeColor`. Verify `src/types.ts` SchemaCard has no `accentColor` field.
  </verify>
  <done>
`index.css` has warm token palette with zero blue hex values. `colors.ts` exports only dimension palette. `types.ts` SchemaCard has no accentColor. `fgaToFlow.ts` does not assign accentColor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all blueprint references to CSS variable references</name>
  <files>
    src/canvas/FgaGraph.tsx
    src/canvas/Canvas.tsx
    src/canvas/Breadcrumb.tsx
    src/canvas/nodes/TypeCardNode.tsx
    src/canvas/edges/DimensionEdge.tsx
    src/editor/fga-theme.ts
    src/editor/EditorPanel.tsx
    src/toolbar/Toolbar.tsx
    src/toolbar/CommandPalette.tsx
    src/inspect/InspectPanel.tsx
    src/components/Tooltip.tsx
    src/components/ResizeHandle.tsx
    src/App.tsx
  </files>
  <action>
For every file that imports `blueprint` from `../theme/colors` (or `../../theme/colors`), remove that import and replace every `blueprint.*` reference with the corresponding `var(--color-*)` CSS variable reference.

**Migration map (apply to ALL files):**

| Old Reference | New Reference |
|---------------|---------------|
| `blueprint.bg` | `var(--color-bg)` |
| `blueprint.surface` | `var(--color-surface)` |
| `blueprint.nodeBg` | `var(--color-surface-raised)` |
| `blueprint.nodeBorder` | `var(--color-border)` |
| `blueprint.nodeHeader` | `var(--color-text-primary)` |
| `blueprint.nodeBody` | `var(--color-text-secondary)` |
| `blueprint.edgeStroke` | `var(--color-border)` |
| `blueprint.edgeArrow` | `var(--color-border)` |
| `blueprint.accent` | `var(--color-accent)` |
| `blueprint.surfaceBorder` | `var(--color-border-subtle)` |
| `blueprint.muted` | `var(--color-text-muted)` |
| `blueprint.danger` | `var(--color-danger)` |
| `blueprint.dotGrid` | `var(--color-dot-grid)` |

**Important patterns to handle:**

1. **Hex alpha appending** -- Patterns like `` `${blueprint.accent}15` `` (appending hex alpha) do NOT work with CSS variables. Replace these with `rgba()` using the accent color value, or use a Tailwind opacity modifier. For example: `` `${blueprint.accent}15` `` becomes `rgba(212, 160, 23, 0.08)` and `` `${blueprint.accent}40` `` becomes `rgba(212, 160, 23, 0.25)`.

2. **`getTypeColor()` call sites** -- In `CommandPalette.tsx` and `InspectPanel.tsx`, replace `getTypeColor(typeName)` with `var(--color-accent)` for type-level items. Remove the import.

3. **`accentColor` usage in TypeCardNode** -- Remove the `accentColor` destructuring from `data` and remove the `borderTop` accent bar that uses it. (The actual card restyle happens in Plan 02, but the dead reference must be removed here for the build to pass.)

4. **Hardcoded rgba values** -- Replace `rgba(15, 23, 41, ...)` and `rgba(15, 23, 42, ...)` patterns (old cold blue) with warm equivalents using the new token values. For example, `rgba(15, 23, 41, 0.95)` becomes `rgba(17, 17, 17, 0.95)`.

5. **Hardcoded hex values** -- Replace `#0f1729`, `#1a2640`, `#2a3a5c`, `#1e3a5c`, `#162033`, `#253553`, `#334155`, `#4a6fa5`, `#1a1a2e` with their `var(--color-*)` equivalents from the migration map above.

After all replacements, no file should import from `theme/colors` except for `DIMENSION_PALETTE`, `TYPE_RESTRICTION_COLOR`, or `assignDimensionColors`. No file should contain `blueprint.` references. Run a grep to confirm.
  </action>
  <verify>
Run `npm run build` -- must pass with zero errors. Run `grep -r "blueprint\." src/ --include="*.ts" --include="*.tsx"` -- must return zero results. Run `grep -r "getTypeColor" src/ --include="*.ts" --include="*.tsx"` -- must return zero results. Run `grep -r "accentColor" src/ --include="*.ts" --include="*.tsx"` -- must return zero results.
  </verify>
  <done>
All 13+ component files reference `var(--color-*)` instead of `blueprint.*`. No file imports `blueprint`, `getTypeColor`, or uses `accentColor`. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `grep -r "blueprint\." src/` returns nothing
3. `grep -r "TYPE_PALETTE" src/` returns nothing (except possibly dimensions.ts if it was there)
4. `grep -r "getTypeColor" src/` returns nothing
5. `grep -r "accentColor" src/` returns nothing
6. `grep -r "#0f1729\|#1a2640\|#2a3a5c\|#1e3a5c\|#162033\|#253553" src/` returns nothing
7. The app loads in browser without console errors (colors may look different but no crashes)
</verification>

<success_criteria>
- Warm dark token palette is the single source of truth in `@theme`
- Zero `blueprint.*` references remain in codebase
- Zero `getTypeColor` / `TYPE_PALETTE` references remain
- Zero `accentColor` references remain
- Build passes cleanly
- App renders without runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-refinement/03-01-SUMMARY.md`
</output>
